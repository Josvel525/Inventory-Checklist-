<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Inventory Report</title>

  <link rel="stylesheet" href="styles.css" />
</head>

<body class="report">
  <header class="topbar topbar--report no-print">
    <div class="topbar__left">
      <div class="brand">
        <div class="brand__mark">ðŸ§¾</div>
        <div class="brand__text">
          <div class="brand__title">Inventory Report</div>
          <div class="brand__subtitle">Print or save as PDF</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <a class="btn btn--ghost" href="index.html">Back</a>
      <button class="btn btn--primary" type="button" id="btnPrint">Print</button>
    </div>
  </header>

  <main class="shell">
    <section class="card report__header">
      <div class="reportHeader">
        <div>
          <h1 class="reportTitle">Venue Inventory Report</h1>
          <div class="reportMeta" id="reportMeta"></div>
        </div>

        <div class="reportStamp">
          <div class="stamp__label">Generated</div>
          <div class="stamp__value" id="generatedAt"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="card__title">Summary</h2>

      <div class="totals" id="summaryTotals"></div>

      <div class="grand">
        <div class="grand__label">Grand Total (all quantities)</div>
        <div class="grand__value" id="summaryGrand">0</div>
      </div>
    </section>

    <section class="card">
      <div class="card__head">
        <h2 class="card__title">Itemized Inventory</h2>
      </div>

      <div id="reportItems"></div>
    </section>

    <footer class="footer">
      <div class="footer__text">Report layout is optimized for iPhone + printing.</div>
    </footer>
  </main>

  <script>
    (function () {
      const STORE_KEY = "venue_inventory_v1";

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function fmtDateISO(iso) {
        if (!iso) return "";
        try {
          const d = new Date(iso + "T00:00:00");
          return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
        } catch {
          return iso;
        }
      }

      function groupBy(items, keyFn) {
        const m = new Map();
        for (const it of items) {
          const k = keyFn(it) || "Other";
          if (!m.has(k)) m.set(k, []);
          m.get(k).push(it);
        }
        return m;
      }

      function computeTotals(items) {
        const categoryTotals = new Map();
        let grand = 0;

        for (const it of items) {
          const qty = Number(it.qty || 0);
          grand += qty;

          const cat = it.category || "Other";
          categoryTotals.set(cat, (categoryTotals.get(cat) || 0) + qty);
        }

        return { categoryTotals, grand };
      }

      function renderTotals(el, categoryTotals) {
        const cats = Array.from(categoryTotals.entries()).sort((a, b) => a[0].localeCompare(b[0]));
        el.innerHTML = cats.map(([cat, qty]) => `
          <div class="totalLine">
            <div class="totalLine__label">${escapeHtml(cat)}</div>
            <div class="totalLine__value">${qty}</div>
          </div>
        `).join("");
      }

      function renderReportItems(el, items) {
        const groups = groupBy(items, it => it.category);
        const cats = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));

        el.innerHTML = cats.map(cat => {
          const list = groups.get(cat).slice().sort((a, b) => (a.name || "").localeCompare(b.name || ""));
          const rows = list.map(it => `
            <tr>
              <td class="td-name">
                <div class="r-name">${escapeHtml(it.name)}</div>
                <div class="r-sub">
                  ${escapeHtml([it.brand, it.productType].filter(Boolean).join(" â€¢ "))}
                </div>
                ${it.notes ? `<div class="r-notes">Notes: ${escapeHtml(it.notes)}</div>` : ""}
              </td>
              <td class="td-unit">${escapeHtml(it.unit || "")}</td>
              <td class="td-qty">${Number(it.qty || 0)}</td>
            </tr>
          `).join("");

          return `
            <div class="reportGroup">
              <div class="reportGroup__title">${escapeHtml(cat)}</div>
              <div class="tableWrap">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="th-unit">Unit</th>
                      <th class="th-qty">Qty</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          `;
        }).join("");
      }

      const raw = localStorage.getItem(STORE_KEY);
      const data = raw ? JSON.parse(raw) : null;

      if (!data) {
        document.getElementById("reportMeta").innerHTML =
          `<div class="pill pill--warn">No saved inventory found. Go back and load/fill the checklist.</div>`;
        return;
      }

      const meta = data.meta || {};
      const items = Array.isArray(data.items) ? data.items : [];

      const metaText = [
        meta.venue ? `Venue: <strong>${escapeHtml(meta.venue)}</strong>` : "",
        meta.event ? `Event: <strong>${escapeHtml(meta.event)}</strong>` : "",
        meta.bartender ? `Bartender: <strong>${escapeHtml(meta.bartender)}</strong>` : "",
        meta.date ? `Date: <strong>${escapeHtml(fmtDateISO(meta.date))}</strong>` : ""
      ].filter(Boolean).join(" &nbsp;â€¢&nbsp; ");

      document.getElementById("reportMeta").innerHTML = metaText || `<div class="pill pill--warn">Missing event info</div>`;

      const now = new Date();
      document.getElementById("generatedAt").textContent = now.toLocaleString();

      const { categoryTotals, grand } = computeTotals(items);
      renderTotals(document.getElementById("summaryTotals"), categoryTotals);
      document.getElementById("summaryGrand").textContent = grand;

      renderReportItems(document.getElementById("reportItems"), items);

      document.getElementById("btnPrint").addEventListener("click", () => window.print());
    })();
  </script>
</body>
</html>
